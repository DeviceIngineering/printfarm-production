name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  PROJECT_PATH: ${{ secrets.PROJECT_PATH }}

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸ“‹ Create deployment info
      run: |
        echo "DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "DEPLOY_COMMIT=${{ github.sha }}" >> $GITHUB_ENV
        echo "DEPLOY_BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV
        echo "DEPLOY_USER=${{ github.actor }}" >> $GITHUB_ENV
    
    - name: ğŸš€ Deploy to server
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'DEPLOY_SCRIPT'
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ PrintFarm Production Deployment"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Time: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          cd ${{ secrets.PROJECT_PATH }} || exit 1
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°
          echo "ğŸ’¾ Saving current state for rollback..."
          git rev-parse HEAD > .last_deployed_commit
          
          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git checkout main
          git pull origin main
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° .env Ñ„Ğ°Ğ¹Ğ»Ğ°
          echo "ğŸ”§ Checking environment configuration..."
          if [ ! -f ".env" ]; then
            echo "âš ï¸ .env file not found, creating from template..."
            cp .env.example .env || echo "No .env.example found"
          fi
          
          # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
          echo "ğŸ›‘ Stopping old containers..."
          docker-compose -f docker-compose.prod.yml down || true
          
          # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ñ… Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²
          echo "ğŸ§¹ Cleaning up unused Docker resources..."
          docker system prune -f
          
          # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ½Ğ¾Ğ²Ñ‹Ñ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ² (production Ğ²ĞµÑ€ÑĞ¸Ñ v7.0)
          echo "ğŸ³ Building and starting containers (Production v7.0)..."
          docker-compose -f docker-compose.prod.yml up -d --build
          
          # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          echo "â³ Waiting for services to start..."
          sleep 45
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
          echo "ğŸ” Checking container status..."
          docker-compose -f docker-compose.prod.yml ps
          
          # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
          echo "ğŸ—ƒï¸ Running database migrations..."
          docker-compose -f docker-compose.prod.yml exec -T backend python manage.py migrate --noinput
          
          # Ğ¡Ğ±Ğ¾Ñ€ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          echo "ğŸ“¦ Collecting static files..."
          docker-compose -f docker-compose.prod.yml exec -T backend python manage.py collectstatic --noinput
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Deployment completed successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
          docker-compose -f docker-compose.prod.yml ps
        DEPLOY_SCRIPT
    
    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ” Running health checks..."
        sleep 15
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ° (port 8090)
        echo "Checking frontend (port 8090)..."
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8090/)
        if [ "$response" != "200" ] && [ "$response" != "301" ]; then
          echo "âŒ Frontend returned $response"
          exit 1
        fi
        echo "âœ… Frontend is up (HTTP $response)"
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° API (port 8001)
        echo "Checking API (port 8001)..."
        api_response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:8001/api/v1/)
        if [ "$api_response" != "200" ] && [ "$api_response" != "401" ]; then
          echo "âŒ API returned $api_response"
          exit 1
        fi
        echo "âœ… API is responding (HTTP $api_response)"
        
        echo "âœ… All health checks passed!"
    
    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š DEPLOYMENT SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸŒ Frontend URL: http://${{ secrets.SERVER_HOST }}:8090"
        echo "ğŸ”§ API URL: http://${{ secrets.SERVER_HOST }}:8001/api/v1"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
        echo "ğŸ“… Time: ${{ env.DEPLOY_TIME }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: ğŸ’¬ Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
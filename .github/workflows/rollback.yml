name: ğŸ”„ Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for rollback'
        required: true
        default: 'Critical bug found'
      commit:
        description: 'Commit SHA to rollback to (leave empty for last known good)'
        required: false

env:
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  PROJECT_PATH: ${{ secrets.PROJECT_PATH }}

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: ğŸ”„ Perform Rollback
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ROLLBACK_SCRIPT'
          set -e
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”„ PrintFarm Rollback Procedure"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“… Time: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ‘¤ Initiated by: ${{ github.actor }}"
          echo "ğŸ“ Reason: ${{ inputs.reason }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          cd ${{ secrets.PROJECT_PATH }} || exit 1
          
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ°
          if [ -n "${{ inputs.commit }}" ]; then
            ROLLBACK_COMMIT="${{ inputs.commit }}"
            echo "ğŸ¯ Rolling back to specified commit: $ROLLBACK_COMMIT"
          elif [ -f ".last_deployed_commit" ]; then
            ROLLBACK_COMMIT=$(cat .last_deployed_commit)
            echo "ğŸ¯ Rolling back to last deployed version: $ROLLBACK_COMMIT"
          else
            echo "âŒ No rollback point found!"
            exit 1
          fi
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          git rev-parse HEAD > .failed_deployment_commit
          
          # ĞÑ‚ĞºĞ°Ñ‚ ĞºĞ¾Ğ´Ğ°
          echo "ğŸ“¥ Rolling back code..."
          git fetch origin
          git checkout $ROLLBACK_COMMIT
          
          # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
          echo "ğŸ›‘ Stopping current containers..."
          docker-compose down
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          echo "ğŸ³ Starting previous version..."
          docker-compose up -d --build
          
          # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          echo "â³ Waiting for services..."
          sleep 30
          
          # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
          echo "ğŸ—ƒï¸ Running migrations..."
          docker-compose exec -T backend python manage.py migrate --noinput
          
          # Ğ¡Ğ±Ğ¾Ñ€ ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          echo "ğŸ“¦ Collecting static files..."
          docker-compose exec -T backend python manage.py collectstatic --noinput
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Rollback completed successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          docker-compose ps
        ROLLBACK_SCRIPT
    
    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ” Verifying rollback..."
        sleep 15
        
        response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}/)
        if [ "$response" != "200" ] && [ "$response" != "301" ]; then
          echo "âŒ Site not responding after rollback!"
          exit 1
        fi
        echo "âœ… Site is working after rollback (HTTP $response)"
    
    - name: ğŸ“Š Rollback Summary
      if: always()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š ROLLBACK SUMMARY"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ”„ Status: ${{ job.status }}"
        echo "ğŸ“ Reason: ${{ inputs.reason }}"
        echo "ğŸ‘¤ Initiated by: ${{ github.actor }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"